#!/bin/bash
set -e

# Post-install script for auto-temp-ctrl

# Check for libgpiod version
REQUIRED_VER="2.1.3"
INSTALLED_VER=$(dpkg-query -W -f='${Version}' libgpiod2 2>/dev/null || echo "none")
if [ "$INSTALLED_VER" = "none" ] || dpkg --compare-versions "$INSTALLED_VER" lt "$REQUIRED_VER"; then
    echo "[auto-temp-ctrl] libgpiod2 version $REQUIRED_VER or newer is required."
    read -p "Install/upgrade libgpiod2 to $REQUIRED_VER now? [Y/n]: " yn
    case $yn in
        [Nn]*) echo "Aborting installation."; exit 1;;
        *) sudo apt-get update && sudo apt-get install -y libgpiod2;;
    esac
fi

# Create venv and install Python package if not already present
VENV_DIR="/opt/auto-temp-ctrl/venv"
PYTHON="python3"
if [ ! -d "$VENV_DIR" ]; then
    mkdir -p /opt/auto-temp-ctrl
    $PYTHON -m venv "$VENV_DIR"
fi
source "$VENV_DIR/bin/activate"
pip install --upgrade pip
pip install auto_temp_gpiod_ctrl

echo "[auto-temp-ctrl] Installation complete. Use 'auto-temp-ctrl help' for usage."
